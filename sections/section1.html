<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Data Visualization Project</title>

    <link rel="stylesheet" href="../css/styles.css">    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://d3js.org/d3.v5.min.js"></script>
</head>

<body class="bg-light d-flex flex-column min-vh-100">
  <nav class="navbar navbar-expand-lg navbar-light bg-success">
      <div class="container">
        <a class="navbar-brand" href="../index.html">
          <img src="../Photo/logo.jpg" alt="Logo" height="60"> <!-- Ingrandito il logo -->
          <strong>Barla Boyz</strong> <!-- Testo in rilievo -->
        </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav ml-auto">
                  <li class="nav-item">
                      <a class="nav-link" href="section1.html"><strong>Section 1</strong></a> <!-- Testo in rilievo -->
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" href="section2.html"><strong>Section 2</strong></a> <!-- Testo in rilievo -->
                  </li>
              </ul>
          </div>
      </div>
  </nav>

  <div class="container text-center flex-grow-1 my-5"> <!-- Aggiunto "flex-grow-1" per far crescere il div e "my-5" per aggiungere spazio sopra e sotto -->
      <div class="row">
          <h2>Grafico a Barre per il Numero di Alberi</h2>
          <select id="city-selector">
              <label for="dataset-dropdown"  style="margin-left: 10px;">Select City:</label>
          </select>
          <div id="bar-chart"></div>          
          <select id="state-selector"></select>
          <div id="stacked-bar-chart"></div>
      </div>
  </div>

  <script>
    d3.json("../Data/dataset1.json").then(function (data) {
      var citySelector = d3.select("#city-selector");
      var cities = [...new Set(data.map((d) => d.city))];
  
      citySelector
        .selectAll("option")
        .data(cities)
        .enter()
        .append("option")
        .attr("value", (d) => d)
        .text((d) => d);
  
      var tooltip = d3
        .select("body")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);
      
      function getAverageHeight(scientificName) {
        // Assuming 'data' is your loaded JSON data
        const treeSpecies = data.find((d) => d.scientific_name === scientificName);
        return treeSpecies ? treeSpecies.avg_height : 'N/A';
      }

      function updateBarChart(city) {
        var filteredData = data.filter((d) => d.city === city);
        var treeCounts = {};
  
        filteredData.forEach(function (d) {
          if (treeCounts[d.scientific_name]) {
            treeCounts[d.scientific_name] += d.count;
          } else {
            treeCounts[d.scientific_name] = d.count;
          }
        });
  
        // Ordina le barre in ordine decrescente e seleziona solo le prime 10
        var sortedCounts = Object.entries(treeCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
  
        var svg = d3.select("#bar-chart");
        svg.selectAll("*").remove(); // Clear the previous content
  
        var margin = { top: 20, right: 20, bottom: 30, left: 140 };
        var width = 800 - margin.left - margin.right;
        var height = 400 - margin.top - margin.bottom;
  
        var chart = svg.append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
  
        var y = d3.scaleBand()
          .range([0, height])
          .padding(0.1)
          .domain(sortedCounts.map((d) => d[0]));
  
        var x = d3.scaleLinear()
          .range([0, width])
          .domain([0, d3.max(sortedCounts, (d) => d[1])]);
  
        chart.selectAll(".bar")
          .data(sortedCounts)
          .enter()
          .append("rect")
          .attr("class", "bar")
          .attr("y", (d) => y(d[0]))
          .attr("width", 0)
          .attr("height", y.bandwidth())
          .attr("fill", "green")
          .on("mouseover", function (d) {
            d3.select(this).style("fill", "lightgreen");

            d3.select(this)
              .transition()
              .duration(200)
              .attr("width", x(d[1]) + 10);
            tooltip.transition().duration(200).style("opacity", 0.9);

           // Customize the tooltip content
           tooltip.html(`Scientific name: ${d[0]}<br>Count: ${d[1]}<br>Average Height: ${getAverageHeight(d[0])} meters`)
                  .style("left",(d3.event.pageX + 40) + "px")
                  .style("top", (d3.event.pageY - 40) + "px");


            /*tooltip
              .html(d[0] + ": " + d[1])
              .style("left", d3.event.pageX + "px")
              .style("top", d3.event.pageY - 28 + "px");*/
          })
          .on("mouseout", function (d) {
            d3.select(this).style("fill", "green");
            d3.select(this)
              .transition()
              .duration(200)
              .attr("width", x(d[1]));
            tooltip.transition().duration(500).style("opacity", 0);
          });
  
        chart.append("g")
          .call(d3.axisLeft(y));
  
        chart.append("g")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x));
  
        // Animation: Transition the bars
        chart.selectAll(".bar")
          .transition()
          .duration(1000)
          .attr("width", (d) => x(d[1]));
      }
  
      updateBarChart(cities[0]);
  
      citySelector.on("change", function () {
        var selectedCity = this.value;
        updateBarChart(selectedCity);
      });
    });
  </script>

  <script>
    d3.json("../Data/dataset1.json").then(function (data) {
    var citySelector = d3.select("#stacked-bar-chart");
    
    function updateStackedBarChart(data) {
    // Filter and process data to get the top 10 cities with the most trees
    data = data.filter((d) => d.city !== null && d.scientific_name !== null && d.count !== null);
    const cities = [...new Set(data.map((d) => d.city))];

    const topCities = cities
      .map((city) => ({
        city,
        totalTrees: d3.sum(data.filter((d) => d.city === city), (d) => d.count),
      }))
      .sort((a, b) => b.totalTrees - a.totalTrees)
      .slice(0, 10);

    // Create a map to store the top 5 tree types for each city
    const top5TreeTypes = new Map();
    topCities.forEach((cityData) => {
      const city = cityData.city;
      const treeTypes = data
        .filter((d) => d.city === city)
        .sort((a, b) => b.count - a.count)
        .slice(0, 5);
      top5TreeTypes.set(city, treeTypes);
    });

    // Define your chart dimensions, scales, and axes
    const margin = { top: 20, right: 20, bottom: 50, left: 70 };
    const width = 800 - margin.left - margin.right;
    const height = 400 - margin.top - margin.bottom;

    const svg = d3.select("#stacked-bar-chart");
    svg.selectAll("*").remove(); // Clear the previous content

    const chart = svg
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    const y = d3.scaleBand().range([0, height]).padding(0.1).domain(topCities.map((d) => d.city));

    const x = d3.scaleLinear().range([0, width]).domain([0, d3.max(topCities, (d) => d.totalTrees)]);

    // Create a color scale for different tree types
    const color = d3.scaleOrdinal(d3.schemeCategory10);

    // Create a group element for the chart
    const bars = chart.selectAll(".bar").data(topCities).enter().append("g");

    // Append the stacked bars to the chart
    bars
      .selectAll("rect")
      .data((d) => top5TreeTypes.get(d.city))
      .enter()
      .append("rect")
      .attr("class", "bar")
      .attr("y", (d) => y(d.city))
      .attr("x", 0)
      .attr("width", (d) => x(d.count))
      .attr("height", y.bandwidth())
      .attr("fill", (d) => color(d.scientific_name));

    // Add tooltips and labels to the bars
    bars
      .selectAll("rect")
      .on("mouseover", function (d) {
        // Add tooltip functionality here
      })
      .on("mouseout", function (d) {
        // Hide tooltip
      });

    // Add axes and legends
    chart.append("g").call(d3.axisLeft(y));
    chart.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));

    // Animation: Transition the bars
    bars
      .selectAll("rect")
      .transition()
      .duration(1000)
      .attr("width", (d) => x(d.count));
  }
});
</script>


      
</body>

<footer class="bg-dark text-light text-center p-2">
    <p>&copy; 2023 Barla Boyz. Tutti i diritti riservati. <a href="privacy.html" class="text-light">Informativa sulla privacy</a></p>
  </footer>
</html>