<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Data Visualization Project</title>
    <link rel="icon" href="../Photo/logo.jpg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/holtzy/D3-graph-gallery@master/LIB/sankey.js"></script>

    
</head>
<body class="bg-light d-flex flex-column min-vh-100">
    <nav class="navbar navbar-expand-lg navbar-light bg-success">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <img src="../Photo/logo.jpg" alt="Logo" height="80">
                <strong>Barla Boyz</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="section1.html"><strong>Section 1</strong></a> 
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="section2.html"><strong>Section 2</strong></a> 
                    </li>
                </ul>
            </div>
        </div>
    </nav>


    <div class="container text-center flex-grow-1 my-5"> <!-- Aggiunto "flex-grow-1" per far crescere il div e "my-5" per aggiungere spazio sopra e sotto -->
        <h1><strong>Assignment 2: Distributions</strong></h1>
        <h2>Alluvial</h2>
        <div id="sankeyDiagram"></div>
    </div>    
    <script>
        // set the dimensions and margins of the graph
        var margin = {top: 10, right: 10, bottom: 10, left: 10},
            width = 450 - margin.left - margin.right,
            height = 480 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3.select("#sankeyDiagram").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
        .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");


        // Set the sankey diagram properties
        var sankey = d3.sankey()
            .nodeWidth(36)
            .nodePadding(290)
            .size([width, height]);

        // load the data
        d3.json("../Data/dataset1.json").then(function(data){

            var stateData = Array.from(d3.group(data, d => d.state), ([name, values]) => ({ name, values }));
            var cityData = Array.from(d3.group(data, d => d.city), ([name, values]) => ({ name, values }));
            var treeData = Array.from(d3.group(data, d => d.scientific_name), ([name, values]) => ({ name, values }));

            var nodes = stateData.concat(cityData, treeData);

              // Create links between nodes
            var links = [];
            cityData.forEach(function(city) {
                stateData.forEach(function(state) {
                links.push({
                    source: state.name,
                    target: city.name,
                    value: city.values.length
                });
                });
                treeData.forEach(function(tree) {
                links.push({
                    source: city.name,
                    target: tree.name,
                    value: tree.values.length
                });
                });
                // Create the sankey diagram
                sankey
                    .nodes(nodes)
                    .links(links)
                    .layout(32);

                // Add in the links
                var link = svg.append("g")
                    .selectAll(".link")
                    .data(links)
                    .enter()
                    .append("path")
                    .attr("class", "link")
                    .attr("d", d3.sankeyLinkHorizontal())
                    .style("stroke", function(d) {
                        return color(d.source.name);
                    })
                    .style("stroke-width", function(d) {
                        return Math.max(1, d.width);
                    })
                    .sort(function(a, b) {
                        return b.dy - a.dy;
                    });

                // Add in the nodes
                var node = svg.append("g")
                    .selectAll(".node")
                    .data(nodes)
                    .enter()
                    .append("g")
                    .attr("class", "node")
                    .attr("transform", function(d) {
                        return "translate(" + d.x + "," + d.y + ")";
                    })
                    .call(d3.drag()
                        .subject(function(d) {
                            return d;
                        })
                        .on("start", function() {
                            this.parentNode.appendChild(this);
                        })
                        .on("drag", dragmove));

                // Add the rectangles for the nodes
                node.append("rect")
                    .attr("height", function(d) {
                        return d.dy;
                    })
                    .attr("width", sankey.nodeWidth())
                    .style("fill", function(d) {
                        return d.color = color(d.name.replace(/ .*/, ""));
                    })
                    .style("stroke", function(d) {
                        return d3.rgb(d.color).darker(2);
                    })
                    .append("title")
                    .text(function(d) {
                        return d.name + "\n" + d.value;
                    });

                // Add in the title for the nodes
                node.append("text")
                    .attr("x", -6)
                    .attr("y", function(d) {
                        return d.dy / 2;
                    })
                    .attr("dy", ".35em")
                    .attr("text-anchor", "end")
                    .attr("transform", null)
                    .text(function(d) {
                        return d.name;
                    })
                    .filter(function(d) {
                        return d.x < width / 2;
                    })
                    .attr("x", 6 + sankey.nodeWidth())
                    .attr("text-anchor", "start");

                // Function to handle drag events
                function dragmove(d) {
                    d3.select(this)
                        .attr("transform",
                            "translate(" +
                            d.x + "," +
                            (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
                    sankey.relayout();
                    link.attr("d", d3.sankeyLinkHorizontal());
                }
            });
        });

    </script>

<footer class="bg-dark text-light text-center p-2">
    <p>&copy; 2023 Barla Boyz. All rights reserved. <a href="../others/privacy.html" class="text-light">Privacy policy</a></p>
</footer>
</body>
</html>