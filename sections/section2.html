<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Data Visualization Project</title>

    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body class="bg-light d-flex flex-column min-vh-100">
    <nav class="navbar navbar-expand-lg navbar-light bg-success">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <img src="../Photo/logo.jpg" alt="Logo" height="60">
                <strong>Barla Boyz</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="section1.html"><strong>Section 1</strong></a> 
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="section2.html"><strong>Section 2</strong></a> 
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container text-center flex-grow-1 my-5"> 
        <div class="row">
            <h2>City comparison by heatmap</h2>
            <div id="heatmap"></div>
        </div>
    </div>

    <script>
        d3.json("../Data/dataset1.json").then(function(data) {
            // Estrai le 10 città diverse più popolose
            const topCities = data
                .sort((a, b) => b.count - a.count)
                .map(d => d.city)
                .filter((value, index, self) => self.indexOf(value) === index)
                .slice(0, 10);
            //stampa le città
            console.log(topCities);

            var tooltip = d3
                .select("body")
                .append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // Estrai i 10 tipi di alberi più presenti
            const topTreeTypes = data
                .sort((a, b) => b.count - a.count)
                .slice(0, 10)
                .map(d => d.scientific_name);

            //stampa gli alberi
            console.log(topTreeTypes);

            const heatmapData = [];
            

            // Costruisci i dati per la heatmap
            for (let i = 0; i < topCities.length; i++) {
                for (let j = 0; j < topTreeTypes.length; j++) {
                    const city = topCities[i];
                    const treeType = topTreeTypes[j];
                    const entry = data.find(d => d.city === city && d.scientific_name === treeType);
                    heatmapData.push({
                        city: city,
                        treeType: treeType,
                        count: entry ? entry.count : 0
                    });
                }
            }

            // Imposta le dimensioni della heatmap
            const width = 800;
            const height = 400;
            const cellSize = 40;
            const margin = {top: 20, right: 20, bottom: 30, left: 140};

            // Scala per l'asse x
            const x = d3.scaleBand()
                .domain(topTreeTypes)
                .range([margin.left, width - margin.right])
                .padding(0.05);

            // Scala per l'asse y
            const y = d3.scaleBand()
                .domain(topCities)
                .range([height - margin.bottom, margin.top])
                .padding(0.05);

            // Scala dei colori
            const colorScale = d3.scaleSequential(d3.interpolateGreens)
                .domain([0, d3.max(heatmapData, d => d.count)]);

            
            //stampa i dati
            console.log(heatmapData);

            // Crea il container per la heatmap
            const svg = d3.select("body")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("margin", margin);

            // Crea l'asse x
            svg.append("g")
                .attr("transform", `translate(0, ${height - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(width / 80).tickSizeOuter(0));
            
            // Crea l'asse y
            svg.append("g")
                .attr("transform", `translate(${margin.left}, 0)`)
                .call(d3.axisLeft(y).tickSizeOuter(0));

            // Crea le celle della heatmap
            const cells = svg.selectAll("rect")
                .data(heatmapData)
                .enter()
                .append("rect")
                .attr("x", (d, i) => (i % topTreeTypes.length) * cellSize)
                .attr("y", (d, i) => Math.floor(i / topTreeTypes.length) * cellSize)
                .attr("width", cellSize)
                .attr("height", cellSize)
                .attr("fill", d => colorScale(d.count));

            // Aggiungi testo alle celle
            svg.selectAll("text")
                .data(heatmapData)
                .enter()
                .append("text")
                .attr("x", (d, i) => (i % topTreeTypes.length) * cellSize + cellSize / 2)
                .attr("y", (d, i) => Math.floor(i / topTreeTypes.length) * cellSize + cellSize / 2)
                .attr("text-anchor", "middle")
                .attr("dominant-baseline", "middle")
                .text(d => d.count);
            
            //per ogni cella voglio un mouseover che mostra un tooltip che mi indica la città, il tipo di albero e il numero di alberi
            cells.on("mouseover", function(event, d) {
                tooltip.transition().duration(200).style("opacity", 0.9);
                tooltip
                    .html(
                        `<strong>${d.city}</strong><br>
                        <strong>${d.treeType}</strong><br>
                        <strong>${d.count}</strong>`
                    )
                    .style("left", event.pageX + "px")
                    .style("top", event.pageY - 28 + "px");
            })
            .on("mouseout", function(event, d) {
                tooltip.transition().duration(500).style("opacity", 0);
            });

            // Aggiungi etichette delle città e dei tipi di alberi
            svg.selectAll("text.city-label")
            .data(topCities)
            .enter()
            .append("text")
            .attr("class", "city-label")
            .attr("x", -40) 
            .attr("y", (d, i) => i * cellSize + cellSize / 2)
            .text(d => d);

            svg.selectAll("text.tree-type-label")
            .data(topTreeTypes)
            .enter()
            .append("text")
            .attr("class", "tree-type-label")
            .attr("x", (d, i) => i * cellSize + cellSize / 2)
            .attr("y", height + 40) 
            .text(d => d);
        });
    </script>

    <footer class="bg-dark text-light text-center p-2">
        <p>&copy; 2023 Barla Boyz. Tutti i diritti riservati. <a href="privacy.html" class="text-light">Informativa sulla privacy</a></p>
    </footer>
</body>
</html>
