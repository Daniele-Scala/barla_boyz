<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alluvial Diagram</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
</head>
<body>

<div id="alluvialDiagram"></div>

<script>
    d3.json("../Data/dataset1.json").then(function (data) {

        // Format the data into a structure that d3-sankey understands
        var sankeyData = {
            nodes: [],
            links: []
        };

        data.forEach(function (d) {
            sankeyData.nodes.push({ name: d.state });
            sankeyData.nodes.push({ name: d.city });
            sankeyData.nodes.push({ name: d.scientific_name });

            sankeyData.links.push({
                source: d.state,
                target: d.city,
                value: d.count
            });

            sankeyData.links.push({
                source: d.city,
                target: d.scientific_name,
                value: d.count
            });
        });

        // Create the alluvial diagram using d3-sankey
        var width = 960;
        var height = 600;

        var sankey = d3.sankey()
            .nodeWidth(15)
            .nodePadding(10)
            .size([width, height])
            .nodes(sankeyData.nodes)
            .links(sankeyData.links)
            .layout(); // No need to call layout separately

        var path = sankey.link();

        var svg = d3.select("#alluvialDiagram")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        var link = svg.append("g")
            .selectAll(".link")
            .data(sankeyData.links)
            .enter().append("path")
            .attr("class", "link")
            .attr("d", path)
            .style("stroke-width", function (d) { return Math.max(1, d.dy); })
            .sort(function (a, b) { return b.dy - a.dy; });

        var node = svg.append("g")
            .selectAll(".node")
            .data(sankey.nodes())
            .enter().append("g")
            .attr("class", "node")
            .attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; });

        node.append("rect")
            .attr("height", function (d) { return d.dy; })
            .attr("width", sankey.nodeWidth());

        node.append("text")
            .attr("x", -6)
            .attr("y", function (d) { return d.dy / 2; })
            .attr("dy", ".35em")
            .attr("text-anchor", "end")
            .attr("transform", null)
            .text(function (d) { return d.name; })
            .filter(function (d) { return d.x < width / 2; })
            .attr("x", 6 + sankey.nodeWidth())
            .attr("text-anchor", "start");
    });
</script>

</body>
</html>
