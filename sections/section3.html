<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alluvial Diagram</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
</head>
<body>

<div id="alluvialDiagram"></div>

<script>
    d3.json("../Data/dataset1.json").then(function (data) {

        // Format the data into a structure that d3-sankey understands
        var sankeyData = {
            nodes: [],
            links: []
        };

        // Separate arrays for each category
        var stateNodes = [];
        var cityNodes = [];
        var speciesNodes = [];

        data.forEach(function (d) {
            var stateNode = findNodeByName(stateNodes, d.state);
            var cityNode = findNodeByName(cityNodes, d.city);
            var speciesNode = findNodeByName(speciesNodes, d.scientific_name);

            sankeyData.links.push({
                source: stateNode,
                target: cityNode,
                value: d.count
            });

            sankeyData.links.push({
                source: cityNode,
                target: speciesNode,
                value: d.count
            });
        });

        // Merge the arrays into a single nodes array
        sankeyData.nodes = stateNodes.concat(cityNodes, speciesNodes);

        // Create the alluvial diagram using d3-sankey
        var width = 960;
        var height = 600;

        var sankey = d3.sankey()
            .nodeWidth(15)
            .nodePadding(10)
            .size([width, height])
            .nodes(sankeyData.nodes)
            .links(sankeyData.links);

        sankey(sankeyData); // This line creates the layout

        var path = d3.linkHorizontal();

        var svg = d3.select("#alluvialDiagram")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        var link = svg.append("g")
            .selectAll(".link")
            .data(sankeyData.links)
            .enter().append("path")
            .attr("class", "link")
            .attr("d", path)
            .style("stroke-width", function (d) { return Math.max(1, d.dy); })
            .sort(function (a, b) { return b.dy - a.dy; });

        var node = svg.append("g")
            .selectAll(".node")
            .data(sankeyData.nodes)
            .enter().append("g")
            .attr("class", "node")
            .attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; });

        node.append("rect")
            .attr("height", function (d) { return d.dy; })
            .attr("width", sankey.nodeWidth());

        node.append("text")
            .attr("x", -6)
            .attr("y", function (d) { return d.dy / 2; })
            .attr("dy", ".35em")
            .attr("text-anchor", "end")
            .attr("transform", null)
            .text(function (d) { return d.name; })
            .filter(function (d) { return d.x < width / 2; })
            .attr("x", 6 + sankey.nodeWidth())
            .attr("text-anchor", "start");
    });

    // Helper function to find or add a node to the nodes array
    function findNodeByName(nodesArray, name) {
        var node = nodesArray.find(function (n) {
            return n && n.name === name;
        });

        if (!node) {
            node = { name: name };
            nodesArray.push(node);
        }

        return node;
    }
</script>

</body>
</html>
